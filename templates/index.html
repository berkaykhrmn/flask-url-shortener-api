<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #ef4444;
            --success: #22c55e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%),
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-main);
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-width: 1000px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
        }

        h1 { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; color: var(--primary); }

        .nav-links { display: flex; gap: 15px; }

        .nav-link {
            padding: 8px 16px;
            border-radius: 10px;
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover { background: #f1f5f9; color: var(--primary); }
        .nav-link.active { background: var(--primary); color: white; }

        .subtitle { color: var(--text-muted); margin-bottom: 30px; font-size: 16px; text-align: center; }

        .input-group { margin-bottom: 20px; }
        label { display: block; color: var(--text-main); font-weight: 600; margin-bottom: 8px; font-size: 13px; }

        input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s;
            background: #f8fafc;
        }

        input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }

        button {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .result {
            margin-top: 30px;
            padding: 24px;
            background: #f1f5f9;
            border-radius: 16px;
            border: 1px dashed #cbd5e1;
            display: none;
        }

        .result.visible { display: block; animation: slideUp 0.4s ease; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .result-url {
            background: white;
            padding: 15px;
            border-radius: 10px;
            color: var(--primary);
            font-weight: 700;
            text-align: center;
            font-size: 20px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
            word-break: break-all;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .stat-value { font-size: 24px; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-top: 5px; }

        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }

        table { width: 100%; border-collapse: collapse; background: white; min-width: 600px; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 12px; text-transform: uppercase; color: var(--text-muted); }
        td { padding: 15px; border-top: 1px solid #f1f5f9; font-size: 14px; }
        tr:hover { background: #fbfcfe; }

        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }
        .badge-expiry { background: #fee2e2; color: #b91c1c; }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 24px;
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .close { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; color: var(--text-muted); }

        .info-message {
            padding: 12px;
            border-radius: 10px;
            font-size: 13px;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .expiry { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .already { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <h1>URL<span style="color:var(--text-main)">Shortener</span></h1>
            <div class="nav-links">
                <a class="nav-link active" id="homeLink">Home</a>
                <a class="nav-link" id="dashboardLink" style="display: none;">Dashboard</a>
                <a class="nav-link" id="loginLink">Login</a>
                <a class="nav-link" id="registerLink">Register</a>
                <a class="nav-link" id="logoutLink" style="display: none; color: var(--danger);">Logout</a>
            </div>
        </div>

        <div id="homeSection">
            <p class="subtitle">Simplified URL shortening for modern creators.</p>
            <form id="shortenForm">
                <div class="input-group">
                    <label>Long URL</label>
                    <input type="url" id="url" placeholder="https://example-long-link.com" required>
                </div>
                <div class="input-group">
                    <label>Custom Code (Optional)</label>
                    <input type="text" id="custom" placeholder="my-custom-code" pattern="[a-zA-Z0-9]{4,16}">
                </div>
                <button type="submit">Shorten</button>
            </form>

            <div class="error" id="error" style="color: var(--danger); text-align: center; margin-top: 15px; font-weight: 600;"></div>

            <div class="result" id="result">
                <div class="info-message" id="infoMessage"></div>
                <div class="stat-label">Your New Link</div>
                <div class="result-url" id="shortUrl"></div>
                <div id="expiryInfo" style="text-align: center; color: var(--text-muted); font-size: 12px; margin-bottom: 15px;"></div>
                <button id="copyBtn" style="background: var(--text-main);">Copy URL</button>
            </div>
        </div>

        <div class="dashboard" id="dashboardSection" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalLinksCount">0</div>
                    <div class="stat-label">Active Links</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalClicksCount">0</div>
                    <div class="stat-label">Total Clicks</div>
                </div>
            </div>

            <div class="table-container">
                <table id="linksTable">
                    <thead>
                        <tr>
                            <th>Short Link</th>
                            <th>Clicks</th>
                            <th>Unique</th>
                            <th>Created</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close" id="closeLogin">&times;</span>
            <h2 style="margin-bottom: 20px;">Welcome Back</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit">Sign In</button>
            </form>
            <div id="loginError" style="color: var(--danger); font-size: 13px; margin-top: 10px;"></div>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <span class="close" id="closeRegister">&times;</span>
            <h2 style="margin-bottom: 20px;">Create Account</h2>
            <form id="registerForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" required minlength="8">
                </div>
                <button type="submit">Register Now</button>
            </form>
            <div id="registerError" style="color: var(--danger); font-size: 13px; margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        const tokenKey = 'authToken';
        const elements = {
            shortenForm: document.getElementById('shortenForm'),
            resultDiv: document.getElementById('result'),
            shortUrlDiv: document.getElementById('shortUrl'),
            infoMessage: document.getElementById('infoMessage'),
            dashboardSection: document.getElementById('dashboardSection'),
            homeSection: document.getElementById('homeSection'),
            linksTableBody: document.querySelector('#linksTable tbody'),
            totalLinks: document.getElementById('totalLinksCount'),
            totalClicks: document.getElementById('totalClicksCount')
        };

        function getToken() { return localStorage.getItem(tokenKey); }
        function setToken(token) { localStorage.setItem(tokenKey, token); }
        function removeToken() { localStorage.removeItem(tokenKey); }
        function getExpiryText() { return getToken() ? "7 days" : "24 hours"; }

        function switchTab(tab) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if (tab === 'home') {
                elements.homeSection.style.display = 'block';
                elements.dashboardSection.style.display = 'none';
                document.getElementById('homeLink').classList.add('active');
            } else {
                elements.homeSection.style.display = 'none';
                elements.dashboardSection.style.display = 'block';
                document.getElementById('dashboardLink').classList.add('active');
                loadDashboard();
            }
        }

        function updateUI() {
            const token = getToken();
            document.getElementById('loginLink').style.display = token ? 'none' : 'block';
            document.getElementById('registerLink').style.display = token ? 'none' : 'block';
            document.getElementById('logoutLink').style.display = token ? 'block' : 'none';
            document.getElementById('dashboardLink').style.display = token ? 'block' : 'none';
        }

        async function loadDashboard() {
            const token = getToken();
            try {
                const res = await fetch('/my-links', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    elements.linksTableBody.innerHTML = '';
                    let clicks = 0;
                    data.links.forEach(link => {
                        clicks += (link.total_clicks || 0);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><a href="${link.short_url}" target="_blank" style="color:var(--primary); text-decoration:none; font-weight:600;">${link.short_url.split('/').pop()}</a></td>
                            <td>${link.total_clicks}</td>
                            <td>${link.unique_ips}</td>
                            <td style="color:var(--text-muted); font-size:12px;">${new Date(link.created_at).toLocaleDateString()}</td>
                            <td><span class="badge badge-expiry">Expires in 7d</span></td>
                        `;
                        elements.linksTableBody.appendChild(row);
                    });
                    elements.totalLinks.textContent = data.links.length;
                    elements.totalClicks.textContent = clicks;
                }
            } catch (e) { console.error(e); }
        }

        elements.shortenForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = getToken();
            try {
                const res = await fetch('/shorten', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token ? `Bearer ${token}` : '' },
                    body: JSON.stringify({ url: document.getElementById('url').value, custom_code: document.getElementById('custom').value || undefined })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');

                elements.shortUrlDiv.textContent = data.short_url;
                elements.resultDiv.classList.add('visible');
                const expiry = getExpiryText();

                elements.infoMessage.className = 'info-message ' + (getToken() ? 'expiry' : 'expiry');
                elements.infoMessage.textContent = getToken() ?
                    `Success! This link is saved to your dashboard.` :
                    `Guest Link: This will vanish in 24 hours. Sign up to keep it for 7 days!`;

                document.getElementById('expiryInfo').textContent = `Auto-delete in ${expiry}`;
            } catch (err) {
                document.getElementById('error').textContent = err.message;
            }
        });

        // Event Listeners for Navigation & Modals
        document.getElementById('homeLink').addEventListener('click', () => switchTab('home'));
        document.getElementById('dashboardLink').addEventListener('click', () => switchTab('dashboard'));
        document.getElementById('loginLink').addEventListener('click', () => document.getElementById('loginModal').style.display = 'flex');
        document.getElementById('registerLink').addEventListener('click', () => document.getElementById('registerModal').style.display = 'flex');
        document.querySelectorAll('.close').forEach(c => c.addEventListener('click', () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none')));

        document.getElementById('logoutLink').addEventListener('click', () => {
            removeToken();
            updateUI();
            switchTab('home');
        });

        document.getElementById('copyBtn').addEventListener('click', function() {
            navigator.clipboard.writeText(elements.shortUrlDiv.textContent);
            this.textContent = 'Copied to Clipboard!';
            setTimeout(() => this.textContent = 'Copy URL', 2000);
        });

        // Auth Forms
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const res = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: document.getElementById('loginEmail').value, password: document.getElementById('loginPassword').value })
            });
            if (res.ok) {
                const data = await res.json();
                setToken(data.access_token);
                location.reload();
            } else {
                document.getElementById('loginError').textContent = 'Invalid credentials';
            }
        });

        window.onload = () => { updateUI(); };
    </script>
</body>
</html>